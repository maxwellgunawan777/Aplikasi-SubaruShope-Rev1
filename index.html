<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Peta Tangerang Raya</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { height: 100%; margin: 0; }
        #map { height: 100vh; width: 100%; z-index: 0; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Scrollbar Halus */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Marker & Animation */
        .pulse-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.3); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(0, 0, 0, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); }
        }

        /* Accordion Transition */
        .accordion-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .accordion-content.active {
            max-height: 1000px;
            opacity: 1;
        }
        
        /* Custom Tooltip Style (Label Kecamatan) */
        .kecamatan-label {
            background-color: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid #cbd5e1 !important;
            border-radius: 9999px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            font-size: 10px !important;
            font-weight: 700 !important;
            color: #334155 !important;
            padding: 2px 8px !important;
            white-space: nowrap !important;
            transition: all 0.2s;
        }
        .kecamatan-label::before { display: none !important; }
        
        .kecamatan-label.highlighted {
            background-color: #f59e0b !important;
            color: white !important;
            border-color: #d97706 !important;
            transform: scale(1.1);
            z-index: 1000 !important;
        }

        /* Kelurahan Label inside Polygon */
        .kelurahan-tooltip {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 600 !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7) !important;
            font-size: 10px !important;
            text-align: center !important;
            opacity: 0.85;
            white-space: normal !important;
            width: 80px;
        }

        /* Locate Control Custom Style */
        .leaflet-control-locate {
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            cursor: pointer;
            width: 30px; 
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }
        .leaflet-control-locate:hover { background: #f4f4f4; }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden text-gray-800 font-sans">

    <!-- Sidebar -->
    <div class="absolute top-4 left-4 z-[1000] w-80 flex flex-col max-h-[90vh] shadow-2xl rounded-xl overflow-hidden transition-transform duration-300" id="sidebar">
        <!-- Header & Search -->
        <div class="bg-slate-800 text-white p-4 pb-3">
            <h1 class="font-bold text-lg flex items-center mb-1">
                <i class="fa-solid fa-map-location-dot text-cyan-400 mr-2"></i> Peta Tangerang
            </h1>
            <p class="text-xs text-slate-300 mb-3">Dashboard Administrasi Tangerang Raya</p>
            
            <!-- Search Input -->
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Cari Kecamatan / Kelurahan..." 
                    class="w-full bg-slate-700 text-white text-sm rounded-lg pl-9 pr-3 py-2 border border-slate-600 focus:outline-none focus:border-cyan-400 placeholder-slate-400 transition">
                <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
            </div>
        </div>

        <!-- Navigation / Content -->
        <div class="glass-panel flex-1 overflow-y-auto custom-scroll p-2">
            <div id="city-list" class="space-y-2">
                <!-- City items generated by JS -->
            </div>
            <!-- Empty State for Search -->
            <div id="no-results" class="hidden p-8 text-center text-gray-400">
                <i class="fa-solid fa-map-location-dot text-3xl mb-2"></i>
                <p class="text-xs">Wilayah tidak ditemukan</p>
            </div>
        </div>

        <!-- Detail Panel (Bottom Fixed inside Sidebar) -->
        <div id="detail-panel" class="bg-white border-t border-gray-200 p-0 hidden transition-all duration-300">
            <!-- Title Bar -->
            <div class="bg-gray-50 p-3 flex justify-between items-center border-b border-gray-100">
                <div>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-blue-600" id="detail-parent">KOTA TANGERANG</span>
                    <h2 class="font-bold text-lg leading-none text-gray-800" id="detail-title">Cipondoh</h2>
                </div>
                <button onclick="closeDetail()" class="text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto max-h-[40vh] custom-scroll">
                <!-- Stats Grid (Simulated Data) -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-blue-50 p-2 rounded border border-blue-100 text-center">
                        <p class="text-[10px] text-blue-500 font-bold uppercase">Populasi</p>
                        <p class="text-lg font-bold text-blue-800" id="stat-population">-</p>
                    </div>
                    <div class="bg-green-50 p-2 rounded border border-green-100 text-center">
                        <p class="text-[10px] text-green-500 font-bold uppercase">Luas (kmÂ²)</p>
                        <p class="text-lg font-bold text-green-800" id="stat-area">-</p>
                    </div>
                </div>

                <p class="text-xs text-gray-500 mb-2 font-semibold flex items-center">
                    <i class="fa-solid fa-layer-group mr-1"></i> Daftar Kelurahan (Lihat Peta):
                </p>
                <div class="flex flex-wrap gap-1" id="detail-tags">
                    <!-- Tags here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Toggle -->
    <button onclick="toggleSidebar()" class="absolute bottom-6 left-4 z-[1000] bg-slate-800 text-white p-3 rounded-full shadow-lg md:hidden hover:bg-slate-700 transition transform hover:scale-105">
        <i class="fa-solid fa-bars"></i>
    </button>

    <!-- Map -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // --- 1. DATA STRUKTUR TANGERANG RAYA ---
        const tangerangData = [
            {
                id: 'kotatangerang',
                name: 'Kota Tangerang',
                color: '#ef4444', // Red
                center: [-6.1783, 106.6319],
                boundary: [[-6.140, 106.580], [-6.140, 106.700], [-6.230, 106.720], [-6.240, 106.600]],
                districts: [
                    { name: 'Tangerang', lat: -6.1710, lng: 106.6400, kels: ['Sukaasih', 'Sukarasa', 'Sukasari', 'Tanah Tinggi', 'Buaran Indah', 'Cikokol', 'Kelapa Indah'] },
                    { name: 'Cibodas', lat: -6.1950, lng: 106.6100, kels: ['Cibodas', 'Cibodasari', 'Cibodas Baru', 'Jatiuwung', 'Panunggangan Barat', 'Uwung Jaya'] },
                    { name: 'Ciledug', lat: -6.2300, lng: 106.7050, kels: ['Sudimara Barat', 'Sudimara Timur', 'Sudimara Selatan', 'Sudimara Jaya', 'Tajur', 'Paninggilan', 'Parung Serab'] },
                    { name: 'Cipondoh', lat: -6.1900, lng: 106.6800, kels: ['Cipondoh', 'Cipondoh Makmur', 'Cipondoh Indah', 'Gondrong', 'Kenanga', 'Ketapang', 'Petir', 'Poris Plawad'] },
                    { name: 'Jatiuwung', lat: -6.2000, lng: 106.5800, kels: ['Alam Jaya', 'Ganda Sari', 'Jatake', 'Keroncong', 'Manis Jaya', 'Pasir Jaya'] },
                    { name: 'Karangtengah', lat: -6.2100, lng: 106.7100, kels: ['Karang Mulya', 'Karang Tengah', 'Karang Timur', 'Parung Jaya', 'Pedurenan', 'Pondok Bahar', 'Pondok Pucung'] },
                    { name: 'Karawaci', lat: -6.1900, lng: 106.6300, kels: ['Bojong Jaya', 'Bugel', 'Cimone', 'Cimone Jaya', 'Gerendeng', 'Karawaci', 'Karawaci Baru', 'Koang Jaya', 'Marga Sari', 'Nambo Jaya', 'Nusa Jaya', 'Pabuaran', 'Pabuaran Tumpeng', 'Pasar Baru', 'Sukajadi', 'Sumur Pancing'] },
                    { name: 'Larangan', lat: -6.2400, lng: 106.7200, kels: ['Cipadu', 'Cipadu Jaya', 'Gaga', 'Kreo', 'Kreo Selatan', 'Larangan Indah', 'Larangan Selatan', 'Larangan Utara'] },
                    { name: 'Neglasari', lat: -6.1500, lng: 106.6300, kels: ['Karang Anyar', 'Karang Sari', 'Kedaung Baru', 'Kedaung Wetan', 'Mekar Sari', 'Neglasari', 'Selapajang Jaya'] },
                    { name: 'Periuk', lat: -6.1700, lng: 106.6000, kels: ['Gebang Raya', 'Gembor', 'Periuk', 'Periuk Jaya', 'Sangiang Jaya'] },
                    { name: 'Pinang', lat: -6.2200, lng: 106.6700, kels: ['Cipete', 'Kunciran', 'Kunciran Indah', 'Kunciran Jaya', 'Nerogtog', 'Pakojan', 'Panunggangan', 'Panunggangan Timur', 'Panunggangan Utara', 'Pinang', 'Sudimara Pinang'] },
                    { name: 'Batuceper', lat: -6.1600, lng: 106.6600, kels: ['Batuceper', 'Batujaya', 'Batusari', 'Kebon Besar', 'Poris Gaga', 'Poris Gaga Baru', 'Poris Jaya'] },
                    { name: 'Benda', lat: -6.1200, lng: 106.6700, kels: ['Belendung', 'Benda', 'Jurumudi', 'Jurumudi Baru', 'Pajang'] }
                ]
            },
            {
                id: 'tangsel',
                name: 'Tangerang Selatan',
                color: '#3b82f6', // Blue
                center: [-6.3100, 106.7000],
                boundary: [[-6.240, 106.650], [-6.240, 106.770], [-6.350, 106.780], [-6.360, 106.650]],
                districts: [
                    { name: 'Serpong', lat: -6.3100, lng: 106.6800, kels: ['Buaran', 'Ciater', 'Cilenggang', 'Lengkong Gudang', 'Lengkong Gudang Timur', 'Lengkong Wetan', 'Rawa Buntu', 'Rawa Mekar Jaya', 'Serpong'] },
                    { name: 'Serpong Utara', lat: -6.2500, lng: 106.6600, kels: ['Jelupang', 'Lengkong Karya', 'Pakualam', 'Pakulonan', 'Paku Jaya', 'Pondok Jagung', 'Pondok Jagung Timur'] },
                    { name: 'Ciputat', lat: -6.3000, lng: 106.7400, kels: ['Cipayung', 'Ciputat', 'Jombang', 'Sawah Baru', 'Sawah Lama', 'Serua', 'Serua Indah'] },
                    { name: 'Ciputat Timur', lat: -6.3000, lng: 106.7600, kels: ['Cempaka Putih', 'Cireundeu', 'Pisangan', 'Pondok Ranji', 'Rempoa', 'Rengas'] },
                    { name: 'Pondok Aren', lat: -6.2600, lng: 106.7200, kels: ['Jurang Mangu Barat', 'Jurang Mangu Timur', 'Pondok Aren', 'Pondok Betung', 'Pondok Jaya', 'Pondok Kacang Barat', 'Pondok Kacang Timur', 'Pondok Karya', 'Pondok Pucung', 'Perigi', 'Perigi Baru'] },
                    { name: 'Pamulang', lat: -6.3400, lng: 106.7300, kels: ['Bambu Apus', 'Benda Baru', 'Kedaung', 'Pamulang Barat', 'Pamulang Timur', 'Pondok Benda', 'Pondok Cabe Ilir', 'Pondok Cabe Udik'] },
                    { name: 'Setu', lat: -6.3500, lng: 106.6800, kels: ['Babakan', 'Bakti Jaya', 'Kademangan', 'Keranggan', 'Muncul', 'Setu'] }
                ]
            },
            {
                id: 'kabtangerang',
                name: 'Kab. Tangerang',
                color: '#a855f7', // Purple
                center: [-6.2000, 106.5000],
                boundary: [[-6.000, 106.400], [-6.000, 106.650], [-6.300, 106.650], [-6.350, 106.450], [-6.200, 106.350]],
                districts: [
                    { name: 'Tigaraksa', lat: -6.2600, lng: 106.4800, kels: ['Kadu Agung', 'Margarita', 'Pasir Bolang', 'Pasir Nangka', 'Pematang', 'Pete', 'Sodong', 'Tapos', 'Tigaraksa', 'Bantar Panjang', 'Cileles', 'Cisereh', 'Matagara'] },
                    { name: 'Cikupa', lat: -6.2300, lng: 106.5200, kels: ['Bunder', 'Cikupa', 'Sukamulya', 'Sukamantri', 'Talaga', 'Talagasari', 'Dukuh', 'Pasir Gadung', 'Pasir Jaya', 'Sukadamai', 'Sukanagara', 'Bitung Jaya', 'Budi Mulya'] },
                    { name: 'Kelapa Dua', lat: -6.2400, lng: 106.6200, kels: ['Bencongan', 'Bencongan Indah', 'Bojong Nangka', 'Curug Sangereng', 'Kelapa Dua', 'Pakulonan Barat'] },
                    { name: 'Curug', lat: -6.2500, lng: 106.5800, kels: ['Binong', 'Cukang Galih', 'Curug Kulon', 'Curug Wetan', 'Kadu', 'Kadu Jaya', 'Sukabakti'] },
                    { name: 'Pasar Kemis', lat: -6.1800, lng: 106.5600, kels: ['Gelam Jaya', 'Kuta Baru', 'Kuta Bumi', 'Kuta Jaya', 'Pangadegan', 'Pasar Kemis', 'Suka Asih', 'Suka Mantri', 'Sindang Sari'] },
                    { name: 'Balaraja', lat: -6.2000, lng: 106.4500, kels: ['Balaraja', 'Cangkudu', 'Gembong', 'Saga', 'Sentul', 'Sentul Jaya', 'Sukabakti', 'Talagasari', 'Tobat'] },
                    { name: 'Cisauk', lat: -6.3200, lng: 106.6400, kels: ['Cisauk', 'Dangdang', 'Mekar Wangi', 'Sampora', 'Suradita', 'Cibogo'] },
                    { name: 'Pagedangan', lat: -6.2800, lng: 106.6300, kels: ['Cicalengka', 'Cihuni', 'Cijantra', 'Jatake', 'Kadu Sirung', 'Karang Tengah', 'Lengkong Kulon', 'Malang Nengah', 'Medang', 'Pagedangan', 'Situ Gadung'] },
                    { name: 'Kosambi', lat: -6.0800, lng: 106.6800, kels: ['Belimbing', 'Cengklong', 'Dadap', 'Jatimulya', 'Kosambi Barat', 'Kosambi Timur', 'Rawa Burung', 'Rawa Rengas', 'Salembaran Jati', 'Salembaran Jaya'] },
                    { name: 'Teluknaga', lat: -6.0900, lng: 106.6400, kels: ['Babakan Asem', 'Bojong Renged', 'Kampung Besar', 'Kampung Melayu Barat', 'Kampung Melayu Timur', 'Kebon Cau', 'Lemo', 'Muara', 'Pangkalan', 'Tanjung Burung', 'Tanjung Pasir', 'Tegal Angus', 'Teluknaga'] },
                    { name: 'Sepatan', lat: -6.1200, lng: 106.5700, kels: ['Karet', 'Kayu Agung', 'Kayu Bongkok', 'Mekar Jaya', 'Pisangan Jaya', 'Pondok Jaya', 'Sarakan', 'Sepatan'] }
                ]
            }
        ];

        // --- 2. INITIALIZE MAP (Center Tangerang) ---
        const map = L.map('map', { 
            zoomControl: false 
        }).setView([-6.2200, 106.6300], 11);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'OpenStreetMap, CartoDB',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- 3. CUSTOM CONTROLS ---
        
        const LocateControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate');
                container.innerHTML = '<i class="fa-solid fa-location-crosshairs text-lg"></i>';
                container.title = "Lokasi Saya";
                container.onclick = function() {
                    if (navigator.geolocation) {
                        container.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-lg"></i>';
                        navigator.geolocation.getCurrentPosition(position => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            if (window.userMarker) map.removeLayer(window.userMarker);
                            
                            window.userMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: '<div class="w-4 h-4 bg-cyan-600 rounded-full border-2 border-white shadow-lg animate-bounce"></div>'
                                })
                            }).addTo(map).bindPopup("Lokasi Anda").openPopup();

                            map.flyTo([lat, lng], 15);
                            container.innerHTML = '<i class="fa-solid fa-location-crosshairs text-lg text-cyan-600"></i>';
                        }, () => {
                            alert("Gagal mendeteksi lokasi.");
                            container.innerHTML = '<i class="fa-solid fa-location-crosshairs text-lg"></i>';
                        });
                    } else {
                        alert("Browser tidak mendukung geolokasi.");
                    }
                };
                return container;
            }
        });
        map.addControl(new LocateControl());


        // --- 4. LOGIC FOR LAYERS ---
        let layers = {
            polygons: L.layerGroup().addTo(map),
            markers: L.layerGroup().addTo(map),
            kelurahans: L.layerGroup().addTo(map) 
        };

        const cityListContainer = document.getElementById('city-list');
        const detailPanel = document.getElementById('detail-panel');
        const searchInput = document.getElementById('searchInput');
        const noResults = document.getElementById('no-results');

        function getStyle(color) {
            return {
                color: color,
                weight: 2,
                opacity: 0.8,
                fillOpacity: 0.05,
                dashArray: '5, 5'
            };
        }

        // --- 5. RENDER UI & MAP ELEMENTS ---
        let allDistricts = []; 

        tangerangData.forEach(city => {
            // A. Draw City Boundary
            const polygon = L.polygon(city.boundary, getStyle(city.color))
                .bindPopup(`<b>${city.name}</b><br>Total Kecamatan: ${city.districts.length}`)
                .addTo(layers.polygons);
            
            polygon.on('click', () => {
                map.flyTo(city.center, 12);
                expandSidebar(city.id);
            });

            // B. Render Sidebar Item
            const cityItem = document.createElement('div');
            cityItem.className = "city-group mb-2 border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm";
            cityItem.id = `group-${city.id}`;
            cityItem.innerHTML = `
                <button onclick="toggleAccordion('${city.id}')" class="w-full px-4 py-3 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition border-b border-gray-100">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-3 shadow-sm" style="background-color: ${city.color}"></div>
                        <span class="font-bold text-sm text-slate-700">${city.name}</span>
                    </div>
                    <i id="icon-${city.id}" class="fa-solid fa-chevron-down text-xs text-gray-400 transition-transform"></i>
                </button>
                <div id="acc-${city.id}" class="accordion-content bg-white">
                    <ul class="text-sm p-2 space-y-1">
                        ${city.districts.map(dist => `
                            <li class="district-item" data-name="${dist.name.toLowerCase()}" data-kels="${dist.kels.join(',').toLowerCase()}">
                                <button onclick="focusDistrict('${city.id}', '${dist.name}')" class="w-full text-left px-3 py-2 rounded hover:bg-slate-50 text-slate-600 hover:text-cyan-600 flex justify-between group items-center transition">
                                    <span class="font-medium">${dist.name}</span>
                                    <span class="text-[10px] text-gray-400 group-hover:text-cyan-500 bg-gray-50 px-2 py-0.5 rounded border border-gray-100">${dist.kels.length}</span>
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            cityListContainer.appendChild(cityItem);

            // C. Create Markers
            city.districts.forEach(dist => {
                allDistricts.push({ cityId: city.id, data: dist });

                const markerHtml = `<div class="pulse-dot" style="background-color: ${city.color}"></div>`;
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: markerHtml,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                const marker = L.marker([dist.lat, dist.lng], { icon: icon })
                    .bindTooltip(dist.name, { 
                        permanent: true, 
                        direction: 'bottom', 
                        offset: [0, 8],
                        className: 'kecamatan-label'
                    });
                
                marker.on('click', () => {
                    showDistrictDetail(city, dist);
                    map.flyTo([dist.lat, dist.lng], 14.5); 
                });

                dist.marker = marker; 
                layers.markers.addLayer(marker);
            });
        });

        // --- 6. INTERACTION & LOGIC ---

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            let hasResults = false;

            tangerangData.forEach(city => {
                const group = document.getElementById(`group-${city.id}`);
                const listItems = group.querySelectorAll('.district-item');
                let cityHasMatch = false;

                listItems.forEach(item => {
                    const distName = item.getAttribute('data-name');
                    const kels = item.getAttribute('data-kels');
                    
                    if (distName.includes(query) || kels.includes(query)) {
                        item.style.display = 'block';
                        cityHasMatch = true;
                        hasResults = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                if (cityHasMatch) {
                    group.style.display = 'block';
                    if (query.length > 0) {
                        document.getElementById(`acc-${city.id}`).classList.add('active');
                        document.getElementById(`icon-${city.id}`).classList.add('rotate-180');
                    }
                } else {
                    group.style.display = 'none';
                }
            });

            if (query.length === 0) {
                tangerangData.forEach(city => {
                    document.getElementById(`group-${city.id}`).style.display = 'block';
                    document.querySelectorAll('.district-item').forEach(i => i.style.display = 'block');
                    document.getElementById(`acc-${city.id}`).classList.remove('active');
                    document.getElementById(`icon-${city.id}`).classList.remove('rotate-180');
                });
                hasResults = true;
            }

            noResults.style.display = hasResults ? 'none' : 'block';
        });

        function toggleAccordion(cityId) {
            tangerangData.forEach(c => {
                if (c.id !== cityId) {
                    document.getElementById(`acc-${c.id}`).classList.remove('active');
                    document.getElementById(`icon-${c.id}`).classList.remove('rotate-180');
                }
            });

            const content = document.getElementById(`acc-${cityId}`);
            const icon = document.getElementById(`icon-${cityId}`);
            content.classList.toggle('active');
            icon.classList.toggle('rotate-180');
        }

        function expandSidebar(cityId) {
             const content = document.getElementById(`acc-${cityId}`);
             if (!content.classList.contains('active')) {
                 toggleAccordion(cityId);
             }
        }

        function focusDistrict(cityId, districtName) {
            const city = tangerangData.find(c => c.id === cityId);
            const dist = city.districts.find(d => d.name === districtName);
            
            if (dist) {
                map.flyTo([dist.lat, dist.lng], 14.5);
                showDistrictDetail(city, dist);
            }
        }

        let currentHighlight = null;

        function showDistrictDetail(city, district) {
            detailPanel.classList.remove('hidden');
            
            // Random stats
            const pop = (Math.floor(Math.random() * 80) + 20) + "." + (Math.floor(Math.random() * 9)) + "rb";
            const area = (Math.random() * 8 + 2).toFixed(1);

            document.getElementById('detail-parent').innerText = city.name;
            document.getElementById('detail-parent').style.color = city.color;
            document.getElementById('detail-title').innerText = "Kec. " + district.name;
            document.getElementById('stat-population').innerText = pop;
            document.getElementById('stat-area').innerText = area;
            
            const tagsContainer = document.getElementById('detail-tags');
            tagsContainer.innerHTML = district.kels.map(k => 
                `<span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-1 rounded border border-gray-200 font-medium hover:bg-cyan-50 hover:text-cyan-600 cursor-default transition">${k}</span>`
            ).join('');

            // Highlight Marker
            if (currentHighlight) {
                currentHighlight.getElement().classList.remove('highlighted');
            }
            const tooltip = district.marker.getTooltip();
            if(tooltip) {
                const el = tooltip.getElement();
                if(el) {
                    el.classList.add('highlighted');
                    currentHighlight = tooltip;
                }
            }

            // Draw Boundaries
            drawKelurahanBoundaries(city, district);

            const sb = document.getElementById('sidebar');
            if (sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full');
            }
        }

        function drawKelurahanBoundaries(city, district) {
            layers.kelurahans.clearLayers();
            
            const lat = district.lat;
            const lng = district.lng;
            const kels = district.kels;
            const count = kels.length;
            
            // Grid logic
            const gridSize = Math.ceil(Math.sqrt(count));
            const step = 0.012; 
            
            const startLat = lat + (step * gridSize / 2);
            const startLng = lng - (step * gridSize / 2);
            
            kels.forEach((name, index) => {
                const row = Math.floor(index / gridSize);
                const col = index % gridSize;
                
                const offsetLat = (Math.random() * 0.002) - 0.001;
                const offsetLng = (Math.random() * 0.002) - 0.001;

                const p1 = [startLat - (row * step) + offsetLat, startLng + (col * step) + offsetLng];
                const p2 = [startLat - (row * step) + offsetLat, startLng + ((col + 1) * step) + offsetLng];
                const p3 = [startLat - ((row + 1) * step) + offsetLat, startLng + ((col + 1) * step) + offsetLng];
                const p4 = [startLat - ((row + 1) * step) + offsetLat, startLng + (col * step) + offsetLng];
                
                const poly = [p1, p2, p3, p4];

                L.polygon(poly, {
                    color: 'white',
                    weight: 1.5,
                    fillColor: city.color,
                    fillOpacity: 0.35
                }).bindTooltip(name, {
                    permanent: true,
                    direction: 'center',
                    className: 'kelurahan-tooltip'
                }).on('mouseover', function (e) {
                    this.setStyle({ fillOpacity: 0.6, weight: 2 });
                }).on('mouseout', function (e) {
                    this.setStyle({ fillOpacity: 0.35, weight: 1.5 });
                }).addTo(layers.kelurahans);
            });
        }

        function closeDetail() {
            detailPanel.classList.add('hidden');
            layers.kelurahans.clearLayers();
            if (currentHighlight) {
                currentHighlight.getElement().classList.remove('highlighted');
                currentHighlight = null;
            }
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('-translate-x-full');
        }

        if (window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
        }

    </script>
</body>
</html>